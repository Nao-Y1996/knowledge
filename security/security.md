# security

参考資料  
・体系的に学ぶ 安全な Web アプリケーションの作り方 第 2 版　 徳丸 浩 (著)
・安全なウェブサイトの作り方（改訂第 7 版）

## 基本知識

- **GET と POST**
  POST ではリクエストボディに送信する値が入る（GET は基本的にリクエストボディはない）。値はリクエストヘッダの`Content-Type`で指定された MIME タイプでエンコードされたものになる（デフォルトではパーセントエンコーディング）。
  GET で何らかのパラメータを送信する場合は URL に埋め込むことができる。そのため、Referer からパラメータが見えてしまう。
- **Cookie によるセッション管理**  
  HTTP はステートレスなため、アプリケーションでステートを保持(=セッション管理)したい場合は「Cookie によるセッション管理」を行う。
  Cookie とはサーバーからブラウザに対して「名前=変数」の組みを覚えさせておく仕組み。サーバーからのレスポンスヘッダで指定可能。
  「Cookie によるセッション管理」では、Cookie には整理番号としての **セッション ID** を格納し、実際の値はサーバーで管理する。Cookie 値を保持したブラウザは同じサイトにリクエストを送る際に、自動的に Cookie 値をリクエストヘッダにれて送信する。
  これにより、ショッピングカート画面から購入確認画面に遷移してもカートの中身が保持される。カートの情報はサーバーで保持しており、ブラウザからはセッション ID の有効期限内であればその情報を見ることができる。

- **同一オリジンポリシー**
  JavaScript などのクライアントスクリプトからサイトをまたがったアクセスを禁止するセキュリティ上の制限のこと。この制限がないと、サイト A にログインしている状態でサイト B にアクセスした時に、もしサイト B がサイト A 内の個人情報を取得するスクリプトを埋め込んでいると、個人情報を抜き取られる恐れがある。
  同一オリジンとは以下 3 つの条件が成り立つこと

  - URL のホスト(FQDN)が一致
  - スキーム(プロトコル)が一致
  - ポート番号が一致

- **CORS(Cros-Origin Resource Sharing)**
  同一オリジンポリシーの制限を超えてデータのやり取りを可能にする技術。
- **XMLHttpRequest**  
  ブラウザなどに実装されている JavaScript の API およびオブジェクトの一つで、スクリプトから HTTP を利用して Web サーバにアクセスする機能を提供する。
  スクリプトの実行と HTTP 通信を同期させる場合はサーバから応答が返るまで一時停止するが、非同期の通信モードを指定することもでき、その場合は応答が完了すると指定された関数が実行される。受信データは XML 形式として展開するか、単純なテキスト形式として処理することができる。原則として Web ページの送信元のサーバとしか通信できない同一オリジンポリシーが適用されるが、サーバ側の設定次第では外部の Web サーバと「クロスドメイン」通信が許可される場合もある。

## さまざまな脆弱性

### SQL インジェクション

- 概要
  SQL 文の組み立て時に問題がある事による脆弱性．パラメータとして受け取ったものを SQL 文に組み込む際に SQL として意味のあるものだった場合に，アプリケーションが意図していない操作が実行され，非公開情報の公開や情報の改ざん，不正ログインなどの危険がある．

- 対策
  SQL 文の組み立てにはプレースホルダーを使う．
  ※文字列連結を行う際はエスケープ処理をする．

静的プレースホルダー：  
プレースホルダのまま SQL をビルドし DB エンジン側で値を割り当てる方式
動的プレースホルダー：
アプリケーションの DB 接続ライブラリ内でエスケープ処理してプレースホルダに当てはめる方式 ．
原理的には静的プレースホルダーの方が安全．

### OS コマンド・インジェクション

- 概要
  シェルを起動する機能の利用で発生する脆弱性．
  アプリケーション内からシェルを操作する際に外部からの入力を引数として受け取るようになっているとファイルの改ざんや不正なシステム操作を引き起こす．

- 対策
  シェルを起動する言語機能を利用しない．

### パス名パラメータの未チェック／ディレクトリ・トラバーサル

- 概要
  外部からのパラメータにサーバー内のファイル名を直接指定している際に発生する脆弱性．サーバ内のファイルの改ざん，削除などを引き起こす．

- 対策
  - 外部からのパラメータでサーバ内のファイル名を直接指定しない．
  - ファイルを開く際は固定のディレクトリを指定した上で，ファイル名にディレクトリ名が含まれないようにする．

### セッションハイジャック

- 概要
  ログイン中ユーザのセッション ID を`不正に取得`されてなりすましが発生する脆弱性．
  【不正に取得されてしまうパターン】

  - セッション ID が推測できてしまう
  - セッション ID が URL に入っている
  - 通信を傍受され暗号化されていない Cookie 情報を見られる

- 対策

  - セッション ID を推測困難なものにする
  - セッション ID を URL に格納しない
  - Coockie に secure 属性をつける  
    secure 属性をつけると HTTPS の時のみ送信されるようになる

### セッション ID の固定化

- 概要
  ログインしていなくてもセッション ID が発行されるようなアプリケーションで発生しうる．
  悪意のあるユーザが自身のセッション ID を何らかの方法で他の利用者使用させ，その利用者がそのセッション ID でログインするとなりすましが発生する．

- 対策
  - ログイン後に新しいセッション ID を付与し古いセッション ID を無効にする．
  - ログイン成功後に成功後に既存のセッション ID とは別に秘密情報を発行し，ページ遷移ごとに秘密情報を確認する．

### クロスサイト・スクリプティング

- 概要
  ユーザの入力などや HTTP ヘッダの情報などをページに出力する際に出力処理に問題があり，スクリプトなどを埋め込まれ，偽ページを表示させられたり Cookie を取得されたりする脆弱性．

- 対策
  入力値のチェックではなく出力の際にチェックをすることが重要．
  - 出力する全ての要素にエスケープ処理をする．
  - URL の出力は「http://」「https://」のみ許可する（javascript:で始まるものもある）
  - スクリプトタグの中身を入力に基づいて動的に生成しない
  - スタイルシートを任意の場所から取り込めるようにしない

### CSRF（クロスサイト・リクエスト・フォージェリ）

- 概要
  外部サイトを経由した悪意のあるリクエストを受け入れてしまう脆弱性
  悪意あるユーザによる罠によって，通常の利用者は自分で意図しないリクエストを送ってしまう．不正な送金，意図しない商品の購入，各種情報の不正な変更などが行われる．

- 脆弱性の 原因

  - form 要素の action 属性にはどのドメインの URL でも指定できる
  - クッキーに保管されたセッション ID は対象サイトに自動的に送信される

- 対策
  正規のリクエストであるか確認することが重要
  - トークンの利用
    サーバ側で推測困難なトークンを生成し，フロント側に渡す．処理を実行するリクエストを送る際にトークンをもらい，生成したものと一致するかを検証する．バックとフロントが API で連携している場合は正規のフロントエンドかどうかを確認した上でトークンを渡す．
  - 処理の実行前にパスワードを要求する
    画面設計の仕様変更を要する，UX が低下するなどの問題もある．
  - Referer が正しいリンク元か検証する
    攻撃者が正規サイト上に罠を設置できる場合には有効ではない

### HTTP ヘッダ・インジェクション

- 概要
  HTTP レスポンスヘッダのフィールド値を，外部からのパラメータのを利用して動的に生成するようなアプリケーションで，HTTP レスポンスヘッダの出力処理に問題がある場合，レスポンスにヘッダを追加したり，任意のボディを作成し，偽のページや意図しないスクリプトが実行させられる．`Location`を追加させると罠サイトに誘導できたり、`Set-Cookie`を追加されると任意のクッキーを生成させられる。

- 対策
  ヘッダの出力はアプリケーションの実行環境や言語に用意されているヘッダ出力用の API を用いる．

### メールヘッダ・インジェクション

- 概要
  アプリケーションのメール送信機能におけるメールヘッダを改ざんできてしまう脆弱性．迷惑メールの送信に悪用されたりする．

- 対策
  ・メールヘッダは固定値にし，外部からの入力は全てメールの本文に出力する．
  ・メールヘッダを固定できない場合はメール送信用の API を用いる．

### クリックジャッキング

- 概要
  HTML の iframe 要素と CSS を巧みに悪用し、透明にした攻撃対象ページと罠サイトを重ね合わせ、利用者が気づかないうちに攻撃対象サイトでのクリックを誘導する攻撃手法。罠サイトは奥、透明にした正規のサイトが手前に来るようになっている。

- 対策
  アプリケーション単体での対策は困難。
  HTTP レスポンスヘッダに X-Frame-Options を追加する．

### バッファオーバーフロー

- 概要
  処理できる量以上のデータを送ることでシステムに誤作動を起こさせる攻撃．
  プログラムが確保したメモリ領域を超えて領域外のメモリを上書きされ，意図しない動作をする可能性がある．

- 対策
  ・直接メモリにアクセスできる言語の使用を最小限にする，その言語を使用しない．

### オープンリダイレクト

- 概要
  パラメータ指定でリダイレクト先を変更できる機能において、任意のドメインにリダイレクトできてしまう脆弱性。リダイレクトに気づかないとフィッシング詐欺などにかかることがある。

`TODO: 4.17.4の内容も含める`

- 対策
  - リダイレクト先をパラメータ指定ではなく固定にする
  - パラメータに直接 URL を指定せずに番号などにする
  - リダイレクト先のドメインをチェックする

#### ファイルをサーバ上のスクリプトとして実行する攻撃

- 概要
  アプリケーションのアップロード機能で、攻撃用のスクリプトをアップロードしたのち、実行させるためのファイルをアップロードする（例えばアップロード後に、ファイルがリンクとして観れる場合にはリンクをクリックした時に実行される）。攻撃用スクリプトで OS コマンドが実行できてしまう。
- 原因
  ・ファイルが公開ディレクトリに保存されている
  ・ファイル名として.php などが指定できる
- 対策
  ファイルを公開ディレクトリに保存しない（拡張子の制限では抜けが生じやすい）。

### 4.15.2 キャッシュからの情報漏洩

### 4.17.1 DOM Base XSS

p441 纏める

### 4.17.2 web ストレージの不適切な利用

p446 纏める

## API 関連の脆弱性

### 前提知識

#### JSONP(JSON with Padding)

JSON に、関数呼び出しなどのコードを付加したもの。CORS(Cros-Origin Resource Sharing)ができる以前に考案された SOP の枠内でクロスドメインのサーバからデータを取得する方法の一つ。  
HTML の script タグの読み込みには SOP 制限がない（script 要素の src 属性では外部の JavaScript を読み込むことができる）ことを利用し、JSON データを関数呼び出しの引数の形で記述する。Web ページ側のスクリプトに同名の関数を用意して引数を受け取るコードを書いておくと、JSONP を script タグで読み込んだあとにその関数が実行され（JSONP は JavaScript そのものと言える）、Web ページ側へ JSON データが JS のオブジェクトとして引き渡される。
以下の例では、

- JSONP でクロスドメインのデータを呼び出す例

  ```html
  <body>
    <script>
      // コールバック関数を定義
      // 次のscriptタグでJSONPデータを読み込んだ時点で実行される
      function hoge(fuga) {
        alert(fuga.message);
      }
    </script>

    <!-- JSONPデータの読み込み -->
    <script src="http://example.com/json.dat"></script>
  </body>
  ```

- json.dat の内容

  ```jsonp
  hoge( { "message" : "Hello World" } );
  ```

Web ページ側とサーバ側ではどのような関数名を用いるかあらかじめ申し合わせておかなければならないが（上記の例では`hoge`）、サーバ側では関数名を URL パラメータとして受け取り、その関数名で JSONP を構成して送り返すという仕組みを採用していることが多い。

- 文字列を受け取るページ

  ```html
  <body>
    <script>
      // コールバック関数を定義
      function display_message(obj) {
        alert(obj.message);
      }
    </script>
    <script src="http://example.com/sample.php?callback=display_message"></script>
  </body>
  ```

- JSONP に対応した文字列を返す API

  ```php
  <?php
    $callback = $_GET['callback'];
    header('Content-Type: text/javascript; charset=utf-8');
    $json = json_encode(array('message' => 'Hello World'));
    echo "$callback($json);";
  ```

### JSONP のエスケープ不備

- 概要
  API で JSON の生成時に適切なエスケープがないと、意図しない JS が混入し実行される危険性がある。
- 対策
  文字列連結や eval 関数ではなく、信頼できる API を用いて JSON を解釈する

### JSON の直接閲覧による XSS

- 概要
  クライアントからのパラメータによってある JSON を返す API において、HTTP レスポンスの`Content-Type`（MIME タイプ)を`application/json`ではなく例えば`text/html`のように指定を誤ると、JS を実行させるようなパラメータが可能になる。
- 対策
  - 【必須】MIME タイプを正しく設定する
  - 【推奨】レスポンスヘッダに`X-Content-Options:nosniff`を設定する  
    （MIME を厳密に判定する）。
  - 【推奨】XML-HttpRequest などの CORS 対応の機能体け呼び出せるようにする。  
     JQuery などの有名ライブラリは XML-HttpRequest のリクエストに`X-Requested-With:XML-Http-Request`ヘッダを自動で付与しており、この動きは広まっている。そのため、API サーバーではこのヘッダの有無をチェックすることで、判別する。

### JSONP のコールバック関数名による XSS

関数名を URL パラメータとして受け取る場合には、`Content-Type`（MIME タイプ)を的つに指定していない場合に発生する（原理は「JSON の直接閲覧による XSS」と同じ）。

- 対策
  - MIME タイプを正しく設定する
  - コールバック関数名の文字種とお文字数を制限する
